<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
  <title>MCS8 JavaScript Client SDK开发指南</title>

  <script src="js/jquery.min.js"></script>
  <script src="js/template-web.js"></script>
  <script src="js/crypto-js.js"></script>
  <link rel="stylesheet" href="js/bootstrap-3.4.1-dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="style.css" />
  <script src="js/bootstrap-3.4.1-dist/js/bootstrap.min.js"></script>

  <link rel="stylesheet" href="js/zTree/css/zTreeStyle/zTreeStyle.css" />
  <script type="text/javascript" src="js/zTree/js/jquery.ztree.core.js"></script>
  <script type="text/javascript" src="js/zTree/js/jquery.ztree.excheck.js"></script>
  <script type="text/javascript" src="js/zTree/js/jquery.ztree.exedit.js"></script>

</head>

<body>

  <nav class="navbar navbar-default">
    <div class="container-fluid">
      <div class="navbar-header">
        <h2>MCS8 JavaScript Client SDK开发指南</h2>
      </div>
      <div class="collapse navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li><a href="MCS8_JS_ClientSDK_Tutorial.zip" download="MCS8_JS_ClientSDK_Tutorial.zip">下载 此教程</a></li>
          <li><a href="MCS8_WebAPI_V2.3.4.pdf" download="MCS8_WebAPI_V2.3.4.pdf">下载 数据管理接口文档（WebApiV2）</a></li>
          <li><a>最后更新：20221130</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="row">
      <div class="col-md-3">
        <ul class="nav nav-pills nav-stacked" id="menu">
          <li class="head">快速上手</li>
          <li><a href="#quick" data-key="quick">快速上手</a></li>
          <li><a href="demo.html" target="_blank" data-key="">第一个例子 》 </a></li>

          <li class="head">WEBSDK-连接网关</li>
          <li><a href="#connect" data-key="connect">鉴权/连接网关</a></li>
          <li><a href="#getDevOnlineList" data-key="getDevOnlineList">获取设备列表（仅在线）</a></li>
          <li><a href="#getDevList" data-key="getDevList">获取设备列表（全部）</a></li>

          <li class="head">WEBSDK-实时视频/对讲</li>
          <li><a href="#openVideo" data-key="openVideo">实时视频/声音监听</a></li>
          <li><a href="#CreateP2pMediaGroup" data-key="CreateP2pMediaGroup">双向视频通话</a></li>
          <li><a href="#CreateP2pMediaGroup6" data-key="CreateP2pMediaGroup6">双向语音通话</a></li>
          <li><a href="#add2MediaGroup" data-key="add2MediaGroup">双向视频通话（接听，设备主呼）</a></li>
          <li><a href="#add2MediaGroup6" data-key="add2MediaGroup6">双向语音通话（接听，设备主呼）</a></li>
          <li><a href="#CreateTempMediaGroup" data-key="CreateTempMediaGroup">集群对讲（多人语音通话组）</a></li>
          <li><a href="#startTalk" data-key="startTalk">向设备喊话</a></li>

          <li class="head">WEBSDK-GPS/设备参数</li>
          <li><a href="#getGps" data-key="getGps">获取实时GPS信息</a></li>
          <li><a href="#getDeviceInfo" data-key="getDeviceInfo">获取设备参数</a></li>

          <li class="head">WEBSDK-消息上报</li>
          <li><a href="#gpsUpload" data-key="gpsUpload">GPS消息上报</a></li>
          <li><a href="#DeviceStatus" data-key="DeviceStatus">设备上下线消息上报</a></li>
          <li><a href="#AlarmUpload" data-key="AlarmUpload">设备SOS报警消息上报</a></li>

          <li class="head">WEBSDK-指令下发</li>
          <li><a href="#startRecord" data-key="startRecord">下发录像指令</a></li>
          <li><a href="#sendWorkNo" data-key="sendWorkNo">下发工单消息</a></li>
          <li><a href="#sendIM" data-key="sendIM">下发文本/TTS消息</a></li>
        </ul>
      </div>
      <div class="col-md-6" id="content">
        <div class="tab-content">

          <!-- 快速入手 -->
          <div class="tab-pane active" id="quick">
            <div class="panel panel-primary">
              <div class="panel-heading">
                <h3 class="panel-title">快速入手</h3>
              </div>
              <div class="panel-body">
                <p>在开始之前，推荐先熟悉 React/Vue 和 ES5/ES6，并正确安装和配置了 Node.js v8 或以上。指南假设你已了解关于 HTML、CSS 和 JavaScript 等知识，并且已经掌握了
                  React/Vue基本开发方式及Web开发基本技能。</p>

                <h3 style="color: #f00;">特别提示</h3>
                <hr>
                <p style="color: #f00;">MCS8 JavaScript Client SDK 仅在安全上下文中(HTTPS)，及所支持的浏览器中使用，并确保已正确配置麦克风、摄像头。</p>
                <ul>
                  <li>Google Chrome</li>
                  <li>Edge</li>
                  <li>Firefox</li>
                  <li>请确保以上所支持的浏览器是较新版本</li>
                </ul>

                <h3>在HTML5使用</h3>
                <hr>
                <textarea class="code" readonly>
<!-- 引用 MCS8 JavaScript Client SDK -->
<script src="js/mcs8Client.js"></script>
<script>
  //参数配置
  var options = {};

  //创建实例
  var mClient = new mcs8Client();
  //连接网关
  mClient.connect(options);

  //注册回调    
  mClient.on('OnManage', function (request) {
    //TODO：
  })
</script>
              </textarea>

                <h3>在ReactJS使用</h3>
                <hr>
                <textarea class="code" readonly>
//使用 import 进行引用
import { mcs8Client } from '@/lib/mcs8Client';

componentDidMount(){
    var options = {
        ...
    };

    //创建实例
    this.mClient = new mcs8Client();
    //连接网关
    this.mClient.connect(options);

    //注册回调    
    this.mClient.on('OnManage', function (request) {
        //TODO：
    })
}
              </textarea>
                <h3>在VueJS使用</h3>
                <hr>
                <textarea class="code" readonly>
//使用 import 进行引用
import { mcs8Client } from '@/lib/mcs8Client';

mounted(){
    var options = {
        ...
    };

    //创建实例
    this.mClient = new mcs8Client();
    //连接网关
    this.mClient.connect(options);

    //注册回调    
    this.mClient.on('OnManage', function (request) {
        //TODO：
    })
}
              </textarea>
              </div>
            </div>
          </div>
          <!-- 快速入手 END -->

          <!-- 连接网关 -->
          <div class="tab-pane" id="connect">
            <div class="panel panel-primary">
              <div class="panel-heading">
                <h3 class="panel-title">连接网关</h3>
              </div>
              <div class="panel-body">
                <form class="form-horizontal">
                  <div class="form-group">
                    <label class="col-sm-2 control-label">调度台网址</label>
                    <div class="col-sm-10">
                      <input type="text" class="form-control" id="txtGatewayUrl" value="https://sys.mcs8.net:7715" />
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="col-sm-2 control-label">调度台/企业账号</label>
                    <div class="col-sm-10">
                      <input type="text" class="form-control" id="txtUsername" value="pc1" />
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="col-sm-2 control-label">调度台/企业密码</label>
                    <div class="col-sm-10">
                      <input type="text" class="form-control" id="txtPassword" placeholder="输入你的账号密码..." value="" />
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="col-sm-2 control-label"></label>
                    <div class="col-sm-10">
                      <button type="button" class="btn btn-primary" id="btnConnect"
                        onClick="FUNC_connect()">连接网关</button>
                    </div>
                  </div>
                </form>
                <div class="alert alert-danger" role="alert">
                  <p><b>特别提示：</b>MCS8 JavaScript Client SDK 仅在安全上下文中(HTTPS)使用，请确保你的域名证书是有效的！</p>
                  <p></p>
                  <p>如果你无有效的域名证书，或域名证书错误、过期、无效，请在浏览器打开你的调度台网址，<button type="button" class="btn btn-danger"
                      id="btnCertificateInvalid">点这里打开你的调度台网址</button></p>
                  <p>在打开的隐私设置页面依次点击[ 高级 ][ 继续前往192.1680.114（不安全） ]（如图所示），设置完成后，请重新连接网关。</p>
                </div>
                <p>
                  <img src="./img/img_1.jpg" style="width: 100%;" />
                  <img src="./img/img_2.jpg" style="width: 100%;" />
                </p>
              </div>
            </div>

            <div class="panel panel-primary">
              <div class="panel-heading">
                <h3 class="panel-title">示例代码（完整示例代码见sdkDemo.js）</h3>
              </div>
              <div class="panel-body">
                <textarea class="code">
                  //调度台地址：https://106.54.78.47:7715

                  let url = new URL(gatewayUrl);
          
                  let httpProxy = null;
                  if (url.port == "") {
                      httpProxy = `:443/gateway`
                  } else {
                      httpProxy = `:${url.port}/gateway`
                  }
          
                  LOG("connect url", url);
          
                  let options = {
                      //用户账号配置：支持调度台账号、企业管理员账号，一般使用调度台账号连接网关
                      uid: username,                           //调度台用户名
                      pwd: password,                           //调度台密码                   
          
                      localVideo: localVideo,
                      localAudio: localAudio,
          
                      //网关连接参数配置，一般情况下使用默认配置即可，非必要不修改
                      host: url.hostname,
                      port: url.port,
                      httpProxy: httpProxy,
                      ssl: url.protocol.startsWith("https"),
                      privateNet: false,
                      encryType: 'v2',
                      encryTime: Math.floor(Date.now() / 1000),
                  }
          
                  //创建实例
                  this.mClient = new mcs8Client();
          
                  //连接网关
                  this.mClient.connect(options);
          
                  LOG("connect", options);
          
                  //注册回调，见onReceived
                  this.mClient.on('OnManage', this.onReceived.bind(this));
                </textarea>
              </div>
            </div>

          </div>
          <!-- 连接网关 END -->

          <!-- 获取在线设备列表 -->
          <div class="tab-pane" id="getDevOnlineList">
            <div class="panel panel-primary">
              <div class="panel-heading">
                <h3 class="panel-title">获取在线设备列表</h3>
              </div>
              <div class="panel-body" id="tpl_getDevOnlineList_content">连接网关，即可演示该功能！</div>
            </div>

            <div class="panel panel-primary">
              <div class="panel-heading">
                <h3 class="panel-title">示例代码（完整示例代码见sdkDemo.js）</h3>
              </div>
              <div class="panel-body">
                <textarea class="code">
sdkclient.mClient.requestMsg2GatewayServer("getDevOnlineList", {}).then(resp => {
  LOG('getDevOnlineList', resp);

  /*获取在线设备列表，Status：状态，0离线，1在线（仅返回在线设备） ：
  resp.Content = [
      {
          "DevId": "pc1",
          "Status": 1
      },
      {
          "DevId": "test1",
          "Status": 1
      }
  ]*/

  //TODO：
})
                </textarea>
              </div>
            </div>

          </div>
          <!-- 获取在线设备列表 END -->

          <!-- 获取全部设备列表 -->
          <div class="tab-pane" id="getDevList">
            <div class="panel panel-primary">
              <div class="panel-heading">
                <h3 class="panel-title">获取全部设备列表</h3>
              </div>
              <div class="panel-body" id="tpl_getDevList_content">
                <ul id="devTree" class="ztree">
                  连接网关，即可演示该功能！
                </ul>
              </div>
            </div>

            <div class="panel panel-primary">
              <div class="panel-heading">
                <h3 class="panel-title">示例代码（完整示例代码见sdkDemo.js）</h3>
              </div>
              <div class="panel-body">
                <textarea class="code" id="devList">
2.10.1 获取设备树

获取当前用户的设备列表，不支持跨企业获取（包括递归）；

该接口以简单树（数据结构，[{id,pid},{id,pid}]）聚合了企业/组/设备/通道等基本信息，以方便应用端展示。

特别说明，返回的设备状态（status）为设备缓存状态，可能存在于实际状态不一致的情况，如需实时设备状态，请通过MCS8 SDK获取。

********************************
请求地址：https://sys.mcs8.net:7715/api/v1/ext/DevTree?token=xxxxxxxxxxxxxx

********************************
获取设备树详细内容见《MCS8平台API文档 数据管理部分.doc》：2.10.1 获取设备树

[
    {
        "id": 20000000,
        "pid": 0,
        "text": "默认企业",
        "type": 1, //type：1企业，2固定组，3设备
        "data": {} //内容见《MCS8平台API文档数据管理部分.doc》：B.1 企业实体模型
    },
    {
        "id": 30000000,
        "pid": 0,
        "text": "默认组",
        "type": 2,
        "data": {}//内容见《MCS8平台API文档数据管理部分.doc》：B.2 组（固定组）实体模型
    },
    {
        "id": 40000000,
        "pid": 30000000,
        "text": "pc1",
        "type": 3,
        "data": {},//内容见《MCS8平台API文档数据管理部分.doc》：B.3 设备实体模型
        "extras": null
    }
]
                </textarea>
              </div>
            </div>

          </div>
          <!-- 获取全部设备列表 END -->

          <!-- 实时视频/声音监听 -->
          <div class="tab-pane" id="openVideo">
            <div class="panel panel-primary">
              <div class="panel-heading">
                <h3 class="panel-title">实时视频/声音监听 <span class="label label-warning">具有视音频功能设备支持</span></h3>
              </div>
              <div class="panel-body" id="tpl_openVideo_content">连接网关，即可演示该功能！</div>
            </div>

            <div class="panel panel-primary">
              <div class="panel-heading">
                <h3 class="panel-title">示例代码（完整示例代码见sdkDemo.js）</h3>
              </div>
              <div class="panel-body">
                <textarea class="code">
/**
* 打开实时视频
* @param {*} devId 设备Id
* @param {*} channelId 通道号（非多通道设备为null）
*/
async function FUNC_openVideo(devId, channelId) {
    var showObj = document.getElementById(`remoteVideo${devId}`);
    var resp = await sdkclient.mClient.openVideo(devId, showObj, channelId);

    console.log("[%s]%s %o", __KEY__, 'openVideo', resp);
}

/**
* 关闭实时视频
* @param {*} devId 设备Id
* @param {*} channelId 通道号（非多通道设备为null）
*/
async function FUNC_closeVideo(devId, channelId) {
    var resp = await sdkclient.mClient.closeVideo(devId, channelId);

    console.log("[%s]%s %o", __KEY__, 'closeVideo', resp);
}

/**
* 打开声音监听
* @param {*} devId 设备Id
* @param {*} channelId 通道号（非多通道设备为null）
*/
async function FUNC_openAudio(devId, channelId) {
    var showObj = document.getElementById(`remoteAudio${devId}`);
    var resp = await sdkclient.mClient.openAudio(devId, showObj, channelId);

    console.log("[%s]%s %o", __KEY__, 'openAudio', resp);
}

/**
* 关闭声音监听
* @param {*} devId 设备Id
* @param {*} channelId 通道号（非多通道设备为null）
*/
async function FUNC_closeAudio(devId, channelId) {
    var resp = await sdkclient.mClient.closeAudio(devId, channelId);

    console.log("[%s]%s %o", __KEY__, 'closeAudio', resp);
}
                </textarea>
              </div>
            </div>

          </div>
          <!-- 实时视频/声音监听 END -->

          <!-- 双向视频通话 -->
          <div class="tab-pane" id="CreateP2pMediaGroup">
            <div class="panel panel-primary">
              <div class="panel-heading">
                <h3 class="panel-title">双向视频通话 <span class="label label-warning">具有视音频功能设备支持</span></h3>
              </div>
              <div class="panel-body" id="tpl_CreateP2pMediaGroup_content">连接网关，即可演示该功能！</div>
            </div>

            <div class="panel panel-primary">
              <div class="panel-heading">
                <h3 class="panel-title">示例代码（完整示例代码见sdkDemo.js）</h3>
              </div>
              <div class="panel-body">
                <textarea class="code">
/**
* 创建双向视频通话组
* @param {*} devId 
*/
async function FUNC_CreateP2pMediaGroup(devId) {
    var groupId = __FUNC_CreateRandomGroupId(devId);
    var groupType = 5; //组类型，4：集群对讲组，5：视频组，6：语音组
    var devModel = { kind: 'video', devId, showObj: document.getElementById(`remoteVideo${devId}`) }
    var resp = await sdkclient.mClient.CreateP2pMediaGroup(groupId, groupType, devModel);

    console.log("[%s]%s %o", __KEY__, 'CreateP2pMediaGroup', resp);

    //监听进入组回调，关联音频元素，见onReceived说明
    sdkclient.addObserver('CreateP2pMediaGroup', msg => {
        if (msg.method == 'newPeer') {
            sdkclient.mClient.addShowObject({
                groupId: __randomGroupIdMap[devId],
                kind: 'audio',
                devId: msg.data.id,
                showObj: document.getElementById(`remoteAudio${msg.data.id}`)
            });
        }
    })
}
                </textarea>
              </div>
            </div>

          </div>
          <!-- 双向视频通话 END -->

          <!-- 双向语音通话 -->
          <div class="tab-pane" id="CreateP2pMediaGroup6">
            <div class="panel panel-primary">
              <div class="panel-heading">
                <h3 class="panel-title">双向语音通话 <span class="label label-warning">具有视音频功能设备支持</span></h3>
              </div>
              <div class="panel-body" id="tpl_CreateP2pMediaGroup6_content">连接网关，即可演示该功能！</div>
            </div>

            <div class="panel panel-primary">
              <div class="panel-heading">
                <h3 class="panel-title">示例代码（完整示例代码见sdkDemo.js）</h3>
              </div>
              <div class="panel-body">
                <textarea class="code">
/**
* 创建双向语音通话组
* @param {*} devId 
*/
async function FUNC_CreateP2pMediaGroup6(devId) {
    var groupId = __FUNC_CreateRandomGroupId(devId);
    var groupType = 6; //组类型，4：集群对讲组，5：视频组，6：语音组
    var devModel = { kind: 'audio', devId, showObj: document.getElementById(`remoteAudio${devId}`) }
    var resp = await sdkclient.mClient.CreateP2pMediaGroup(groupId, groupType, devModel);

    console.log("[%s]%s %o", __KEY__, 'CreateP2pMediaGroup', resp);
}
                </textarea>
              </div>
            </div>

          </div>
          <!-- 双向语音通话 END -->

          <!-- 接听设备视频呼叫 -->
          <div class="tab-pane" id="add2MediaGroup">
            <div class="panel panel-primary">
              <div class="panel-heading">
                <h3 class="panel-title">接听设备视频呼叫 <span class="label label-warning">具有视音频功能设备支持</span></h3>
              </div>
              <div class="panel-body" id="tpl_add2MediaGroup_content">连接网关，即可演示该功能！</div>
            </div>

            <div class="panel panel-primary">
              <div class="panel-heading">
                <h3 class="panel-title">示例代码（完整示例代码见sdkDemo.js）</h3>
              </div>
              <div class="panel-body">
                <textarea class="code">
                  //被动呼叫，包括视频呼叫、语音呼叫，一般流程为：
        //1、在回调里监听 [JoinRoomAndProduct] 命令字，此命令字表示来自设备端的呼叫；
        //2、加入群组：add2MediaGroup
        //3、加入群组后，然后监听[JoinRoom]，并关联HTML音频、视频元素

        //监听回调消息类型，见onReceived->method：JoinRoomAndProduct说明
        sdkclient.addObserver('add2MediaGroup', msg => {
            if (msg.method == 'JoinRoomAndProduct') {
                var data = { list: [msg.data] };
                var html = template(`tpl_${key}`, data);
                document.getElementById(`tpl_${key}_content`).innerHTML = html;
            } else if (msg.method === 'joinRoom') {
                //关联音频和视频HTML元素
                for (const peer of msg.data.peers) {
                    sdkclient.mClient.addShowObject({
                        groupId: msg.data.groupId,
                        kind: 'audio',
                        devId: peer.id,
                        showObj: document.getElementById(`remoteAudio${peer.id}`)
                    });

                    if (msg.data.groupType == 5) { //视频组
                        sdkclient.mClient.addShowObject({
                            groupId: msg.data.groupId,
                            kind: 'video',
                            devId: peer.id,
                            showObj: document.getElementById(`remoteVideo${peer.id}`)
                        });
                    }
                }
            }
        })
                </textarea>
              </div>
            </div>

          </div>
          <!-- 接听设备视频呼叫 END -->

          <!-- 接听设备语音呼叫 -->
          <div class="tab-pane" id="add2MediaGroup6">
            <div class="panel panel-primary">
              <div class="panel-heading">
                <h3 class="panel-title">接听设备语音呼叫 <span class="label label-warning">具有视音频功能设备支持</span></h3>
              </div>
              <div class="panel-body" id="tpl_add2MediaGroup6_content">连接网关，即可演示该功能！</div>
            </div>

            <div class="panel panel-primary">
              <div class="panel-heading">
                <h3 class="panel-title">示例代码（完整示例代码见sdkDemo.js）</h3>
              </div>
              <div class="panel-body">
                <textarea class="code">
                  //被动呼叫，包括视频呼叫、语音呼叫，一般流程为：
        //1、在回调里监听 [JoinRoomAndProduct] 命令字，此命令字表示来自设备端的呼叫；
        //2、加入群组：add2MediaGroup
        //3、加入群组后，然后监听[JoinRoom]，并关联HTML音频、视频元素

        //监听回调消息类型，见onReceived->method：JoinRoomAndProduct说明
        sdkclient.addObserver('add2MediaGroup', msg => {
            if (msg.method == 'JoinRoomAndProduct') {
                var data = { list: [msg.data] };
                var html = template(`tpl_${key}`, data);
                document.getElementById(`tpl_${key}_content`).innerHTML = html;
            } else if (msg.method === 'joinRoom') {
                //关联音频和视频HTML元素
                for (const peer of msg.data.peers) {
                    sdkclient.mClient.addShowObject({
                        groupId: msg.data.groupId,
                        kind: 'audio',
                        devId: peer.id,
                        showObj: document.getElementById(`remoteAudio${peer.id}`)
                    });

                    if (msg.data.groupType == 5) { //视频组
                        sdkclient.mClient.addShowObject({
                            groupId: msg.data.groupId,
                            kind: 'video',
                            devId: peer.id,
                            showObj: document.getElementById(`remoteVideo${peer.id}`)
                        });
                    }
                }
            }
        })
                </textarea>
              </div>
            </div>

          </div>
          <!-- 接听设备视频呼叫 END -->

          <!-- 多人语音通话 -->
          <div class="tab-pane" id="CreateTempMediaGroup">
            <div class="panel panel-primary">
              <div class="panel-heading">
                <h3 class="panel-title">集群对讲（多人语音通话组） <span class="label label-warning">具有视音频功能设备支持</span></h3>
              </div>
              <div class="panel-body" id="tpl_CreateTempMediaGroup_content">连接网关，即可演示该功能！</div>
            </div>

            <div class="panel panel-primary">
              <div class="panel-heading">
                <h3 class="panel-title">示例代码（完整示例代码见sdkDemo.js）</h3>
              </div>
              <div class="panel-body">
                <textarea class="code">
/**
* 创建多人语音通话组（集群对讲）
* @param {*} groupKey 
* @returns 
*/
async function FUNC_CreateTempMediaGroup(groupKey) {

    var devList = [];
    $("#CreateTempMediaGroup").find("input:checkbox:checked").each((i, item) => {
        devList.push(
            {
                kind: 'audio',
                devId: item.value,
                showObj: document.getElementById(`remoteAudio${item.value}`)
            }
        );
    });

    if (devList.length == 0) {
        alert("未选择设备");
        return;
    }

    var groupId = __FUNC_CreateRandomGroupId(groupKey);
    var groupType = 4; //组类型，4：集群对讲组，5：视频组，6：语音组
    var resp = await sdkclient.mClient.CreateTempMediaGroup(groupId, groupType, devList);

    console.log("[%s]%s %o", __KEY__, 'CreateTempMediaGroup', resp);
}

/**
* 申请发言权（排他性）
* @param {*} groupKey 
*/
async function FUNC_applyTalk(groupKey) {
    var resp = await sdkclient.mClient.applyTalk(__randomGroupIdMap[groupKey]);

    console.log("[%s]%s %o", __KEY__, 'applyTalk', resp);

    if (resp && resp.status === 1) {
        alert("请发言！说点什么呢...");
    } else {
        alert("~打断别人说话是不礼貌的行为~");
    }
}

/**
* 释放发言权
* @param {*} groupKey 
*/
async function FUNC_freeTalker(groupKey) {
    await sdkclient.mClient.freeTalker(__randomGroupIdMap[groupKey]);
}

/**
* 关闭通话组
*/
async function FUNC_closeGroup(devId) {

    sdkclient.removeObserver("CreateP2pMediaGroup");

    var resp = await sdkclient.mClient.closeGroup(__randomGroupIdMap[devId]);

    console.log("[%s]%s %o", __KEY__, 'closeGroup', resp);
}
                </textarea>
              </div>
            </div>

          </div>
          <!-- 多人语音通话 END -->

          <!-- 向设备喊话 -->
          <div class="tab-pane" id="startTalk">
            <div class="panel panel-primary">
              <div class="panel-heading">
                <h3 class="panel-title">向设备喊话 <span class="label label-warning">具有视音频功能设备支持</span></h3>
              </div>
              <div class="panel-body" id="tpl_startTalk_content">连接网关，即可演示该功能！</div>
            </div>

            <div class="panel panel-primary">
              <div class="panel-heading">
                <h3 class="panel-title">示例代码（完整示例代码见sdkDemo.js）</h3>
              </div>
              <div class="panel-body">
                <textarea class="code">
/**
* 开始喊话
* @param {*} devId 
* @param {*} channelId 
*/
async function FUNC_startTalk(devId, channelId) {
    var resp = await sdkclient.mClient.startTalk(devId, channelId);

    console.log("[%s]%s %o", __KEY__, 'startTalk', resp);
}

/**
* 停止喊话
* @param {*} devId 
* @param {*} channelId 
*/
async function FUNC_stopTalk(devId, channelId) {
    var resp = await sdkclient.mClient.stopTalk();

    console.log("[%s]%s %o", __KEY__, 'stopTalk', resp);
}
                </textarea>
              </div>
            </div>

          </div>
          <!-- 向设备喊话 END -->

          <!-- 获取实时位置 -->
          <div class="tab-pane" id="getGps">
            <div class="panel panel-primary">
              <div class="panel-heading">
                <h3 class="panel-title">获取实时位置 <span class="label label-warning">具有定位功能设备支持</span></h3>
              </div>
              <div class="panel-body" id="tpl_getGps_content">连接网关，即可演示该功能！</div>
            </div>

            <div class="panel panel-primary">
              <div class="panel-heading">
                <h3 class="panel-title">示例代码（完整示例代码见sdkDemo.js）</h3>
              </div>
              <div class="panel-body">
                <textarea class="code">
sdkclient.mClient.requestMsg2GatewayServer('getGps', { devId }).then(resp => {
  LOG('getGps', resp);

  //消息类型，见onReceived->method：gpsUpload说明

  //TODO：
})
                </textarea>
              </div>
            </div>

          </div>
          <!-- 获取实时位置 END -->

          <!-- 获取设备参数 -->
          <div class="tab-pane" id="getDeviceInfo">
            <div class="panel panel-primary">
              <div class="panel-heading">
                <h3 class="panel-title">获取设备参数 <span class="label label-warning">DSJ-V1、DSJ-V2设备支持</span></h3>
              </div>
              <div class="panel-body" id="tpl_getDeviceInfo_content">连接网关，即可演示该功能！</div>
            </div>

            <div class="panel panel-primary">
              <div class="panel-heading">
                <h3 class="panel-title">示例代码（完整示例代码见sdkDemo.js）</h3>
              </div>
              <div class="panel-body">
                <textarea class="code">

sdkclient.mClient.requestMsg2GatewayServer('getDeviceInfo', { devId }).then(resp => {
    LOG('getDeviceInfo', resp);

    //"network": 1, //网络类型：1WIFI，2移动网络   
    //"recording": 2, //录像状态：1正在录像，2未录像
    //"totalSize": 50319328, //存储容量（字节）
    //"useSize": 4209568, //已用容量
    //"battery": 71, //电量（%）
    //"lat": 22.57688333333333, //维度，WGS84(大地坐标)
    //"lng": 113.91682, //经度，WGS84(大地坐标)
    //"hardware": "N6F26Q test-keys", //固件版本
    //"version": "1.5.44", //APP版本
    //"peopleNo": "000000", //人员编号
    //"workNo": "8600021935078769" //工单号

    //TODO：
})
                </textarea>
              </div>
            </div>

          </div>
          <!-- 获取设备参数 END -->

          <!-- GPS消息上报 -->
          <div class="tab-pane" id="gpsUpload">
            <div class="panel panel-primary">
              <div class="panel-heading">
                <h3 class="panel-title">GPS消息上报</h3>
              </div>
              <div class="panel-body" id="tpl_gpsUpload_content">连接网关，即可演示该功能！</div>
            </div>

            <div class="panel panel-primary">
              <div class="panel-heading">
                <h3 class="panel-title">示例代码（完整示例代码见sdkDemo.js）</h3>
              </div>
              <div class="panel-body">
                <textarea class="code">
//监听回调消息类型，见onReceived->method：gpsUpload说明
sdkclient.addObserver('gpsUpload', msg => {
    if (msg.method == 'gpsUpload') {
        //TODO：
    }
})
                </textarea>
              </div>
            </div>

          </div>
          <!-- GPS消息上报 END -->

          <!-- 设备上下线消息上报 -->
          <div class="tab-pane" id="DeviceStatus">
            <div class="panel panel-primary">
              <div class="panel-heading">
                <h3 class="panel-title">设备上下线消息上报</h3>
              </div>
              <div class="panel-body" id="tpl_DeviceStatus_content">连接网关，即可演示该功能！</div>
            </div>

            <div class="panel panel-primary">
              <div class="panel-heading">
                <h3 class="panel-title">示例代码（完整示例代码见sdkDemo.js）</h3>
              </div>
              <div class="panel-body">
                <textarea class="code">
//监听回调消息类型，见onReceived->method：DeviceStatus说明
sdkclient.addObserver('DeviceStatus', msg => {
    if (msg.method == 'DeviceStatus') {
        //TODO：
    }
})
          </textarea>
              </div>
            </div>

          </div>
          <!-- 设备上下线消息上报 END -->

          <!-- 设备SOS报警消息上报 -->
          <div class="tab-pane" id="AlarmUpload">
            <div class="panel panel-primary">
              <div class="panel-heading">
                <h3 class="panel-title">设备SOS报警消息上报 <span class="label label-warning">DSJ-V1、DSJ-V2设备支持</span></h3>
              </div>
              <div class="panel-body" id="tpl_AlarmUpload_content">连接网关，即可演示该功能！</div>
            </div>

            <div class="panel panel-primary">
              <div class="panel-heading">
                <h3 class="panel-title">示例代码（完整示例代码见sdkDemo.js）</h3>
              </div>
              <div class="panel-body">
                <textarea class="code">
//监听回调消息类型，见onReceived->method：AlarmUpload说明
sdkclient.addObserver('AlarmUpload', msg => {
    if (msg.method == 'AlarmUpload') {
        //TODO：
    }
})
          </textarea>
              </div>
            </div>

          </div>
          <!-- 设备SOS报警消息上报 END -->

          <!-- 下发录像指令 -->
          <div class="tab-pane" id="startRecord">
            <div class="panel panel-primary">
              <div class="panel-heading">
                <h3 class="panel-title">下发录像指令 <span class="label label-warning">DSJ-V1、DSJ-V2设备支持</span></h3>
              </div>
              <div class="panel-body" id="tpl_startRecord_content">连接网关，即可演示该功能！</div>
            </div>

            <div class="panel panel-primary">
              <div class="panel-heading">
                <h3 class="panel-title">示例代码（完整示例代码见sdkDemo.js）</h3>
              </div>
              <div class="panel-body">
                <textarea class="code">
      </textarea>
              </div>
            </div>

          </div>
          <!-- 下发录像指令 END -->

          <!-- 下发工单信息 -->
          <div class="tab-pane" id="sendWorkNo">
            <div class="panel panel-primary">
              <div class="panel-heading">
                <h3 class="panel-title">下发工单信息 <span class="label label-warning">DSJ-V1、DSJ-V2设备支持</span></h3>
              </div>
              <div class="panel-body" id="tpl_sendWorkNo_content">连接网关，即可演示该功能！</div>
            </div>

            <div class="panel panel-primary">
              <div class="panel-heading">
                <h3 class="panel-title">示例代码（完整示例代码见sdkDemo.js）</h3>
              </div>
              <div class="panel-body">
                <textarea class="code">
      </textarea>
              </div>
            </div>

          </div>
          <!-- 下发工单信息 END -->

          <!-- 下发文本消息 -->
          <div class="tab-pane" id="sendIM">
            <div class="panel panel-primary">
              <div class="panel-heading">
                <h3 class="panel-title">下发文本消息 <span class="label label-warning">DSJ-V1、DSJ-V2设备支持</span></h3>
              </div>
              <div class="panel-body" id="tpl_sendIM_content">连接网关，即可演示该功能！</div>
            </div>

            <div class="panel panel-primary">
              <div class="panel-heading">
                <h3 class="panel-title">示例代码（完整示例代码见sdkDemo.js）</h3>
              </div>
              <div class="panel-body">
                <textarea class="code">
      </textarea>
              </div>
            </div>

          </div>
          <!-- 下发文本消息 END -->

        </div>
      </div>
      <div class="col-md-3">

        <div class="panel panel-default">
          <div class="panel-heading">
            <h3 class="panel-title">日志</h3>
          </div>
          <div id="log" class="panel-body code" style="overflow-y:scroll;overflow-x: auto;">
          </div>
        </div>

      </div>
    </div>

    <div style="display:none">
      <video id="localVideo" autoplay controls></video>
      <audio id="localAudio" autoplay controls></audio>
    </div>

  </div>
</body>

<!-- 获取在线设备列表 模块 -->
<script id="tpl_getDevOnlineList" type="text/html">
  <table class="table table-bordered">
      <tr>
          <th>设备Id</th>
          <th>状态（1在线）</th>
      </tr>
  {{each list item}}
      <tr>
          <td>
              {{item.DevId}}
          </td>
          <td>
              {{item.Status}}
          </td>
      </tr>        
  {{/each}}
</table>
</script>

<!-- 实时视频 模块 -->
<script id="tpl_openVideo" type="text/html">
  <div class="row">
  {{each list item}}
    <div class="col-sm-6">
        <div class="thumbnail">
            <video id="remoteVideo{{item.DevId}}" controls autoplay muted></video>
            <audio id="remoteAudio{{item.DevId}}" controls autoplay></audio>
            <div class="caption">
                <h3>{{item.DevId}}</h3>     
                <p><button class="btn btn-primary" onclick="FUNC_openVideo('{{item.DevId}}')" >打开实时视频</button>
                   <button class="btn btn-default" onclick="FUNC_closeVideo('{{item.DevId}}')">关闭实时视频</button></p>
                <p><button class="btn btn-primary" onclick="FUNC_openAudio('{{item.DevId}}')" >打开声音监听</button>
                   <button class="btn btn-default" onclick="FUNC_closeAudio('{{item.DevId}}')">关闭声音监听</button></p>
            </div>
        </div>
    </div>
  {{/each}}
</div>
</script>

<!-- 双向视频通话 模块 -->
<script id="tpl_CreateP2pMediaGroup" type="text/html">
  <div class="row">
    {{each list item}}
    <div class="col-sm-6">
        <div class="thumbnail">
            <video id="remoteVideo{{item.DevId}}" controls autoplay muted></video>
            <audio id="remoteAudio{{item.DevId}}" controls autoplay></audio>
            <div class="caption">
                <h3>{{item.DevId}}</h3>     
                <p><button class="btn btn-primary" onclick="FUNC_CreateP2pMediaGroup('{{item.DevId}}')" >发起视频通话</button>
                <button class="btn btn-default" onclick="FUNC_closeGroup('{{item.DevId}}')">关闭视频通话</button></p>
            </div>
        </div>
    </div>
    {{/each}}
  </div>
</script>

<!-- 双向语音通话 模块 -->
<script id="tpl_CreateP2pMediaGroup6" type="text/html">
  <div class="row">
    {{each list item}}
    <div class="col-sm-6">
        <div class="thumbnail">
            <audio id="remoteAudio{{item.DevId}}" controls autoplay></audio>
            <div class="caption">
                <h3>{{item.DevId}}</h3>     
                <p><button class="btn btn-primary" onclick="FUNC_CreateP2pMediaGroup6('{{item.DevId}}')" >发起语音通话</button>
                <button class="btn btn-default" onclick="FUNC_closeGroup('{{item.DevId}}')">关闭语音通话</button></p>
            </div>
        </div>
    </div>
    {{/each}}
  </div>
</script>

<!-- 双向视频通话 模块 -->
<script id="tpl_CreateP2pMediaGroup" type="text/html">
  <div class="row">
    {{each list item}}
    <div class="col-sm-6">
        <div class="thumbnail">
            <video id="remoteVideo{{item.DevId}}" controls autoplay muted></video>
            <audio id="remoteAudio{{item.DevId}}" controls autoplay></audio>
            <div class="caption">
                <h3>{{item.DevId}}</h3>     
                <p><button class="btn btn-primary" onclick="FUNC_CreateP2pMediaGroup('{{item.DevId}}')" >发起视频通话</button>
                <button class="btn btn-default" onclick="FUNC_closeGroup('{{item.DevId}}')">关闭视频通话</button></p>
            </div>
        </div>
    </div>
    {{/each}}
  </div>
</script>

<!-- 接听设备视频呼叫 模块 -->
<script id="tpl_add2MediaGroup" type="text/html">
  <div class="row">
    {{each list item}}
    <div class="col-sm-6">
        <div class="thumbnail">       
          <video id="remoteVideo{{item.creatorId}}" controls autoplay muted></video>
            <audio id="remoteAudio{{item.creatorId}}" controls autoplay></audio>
            <div class="caption">
                <h3>{{item.creatorId}}</h3>     
                <p><button class="btn btn-primary" onclick="FUNC_add2MediaGroup('{{item.roomId}}','{{item.TalkGroupType}}')" >接听</button>                
                <button class="btn btn-default" onclick="FUNC_closeGroup('{{item.creatorId}}','{{item.roomId}}')">挂断</button></p>
            </div>
        </div>
    </div>
    {{/each}}
  </div>
</script>

<!-- 接听设备语音呼叫 模块 -->
<script id="tpl_add2MediaGroup6" type="text/html">
  <div class="row">
    {{each list item}}
    <div class="col-sm-6">
        <div class="thumbnail">  
            <audio id="remoteAudio{{item.creatorId}}" controls autoplay></audio>
            <div class="caption">
                <h3>{{item.DevId}}</h3>     
                <p><button class="btn btn-primary" onclick="FUNC_add2MediaGroup('{{item.roomId}}','{{item.TalkGroupType}}')" >接听</button>                
                <button class="btn btn-default" onclick="FUNC_closeGroup('{{item.creatorId}}','{{item.roomId}}')">挂断</button></p>
            </div>
        </div>
    </div>
    {{/each}}
  </div>
</script>

<!-- 多人语音通话 模块 -->
<script id="tpl_CreateTempMediaGroup" type="text/html">
  <div class="row">
    {{each list item}}
    <div class="col-md-6">
        <div class="thumbnail">
            <audio id="remoteAudio{{item.DevId}}" controls autoplay></audio>
            <div class="caption">
                <h3><label><input type="checkbox" name="devId" value="{{item.DevId}}"> {{item.DevId}}</label></h3>
            </div>
        </div>
    </div>
    {{/each}}    
    <div class="col-md-12">
        <div class="thumbnail">
            <div class="caption">
                <p>第一步：勾选设备->发起通话</p>
                <p><button class="btn btn-primary" onclick="FUNC_CreateTempMediaGroup('my')">发起多人通话</button>
                   <button class="btn btn-default" onclick="FUNC_closeGroup('my')">关闭多人通话</button></p>      
                <p>第三步：申请发言</p>
                <p><button class="btn btn-info" onclick="FUNC_applyTalk('my')">申请发言</button>
                   <button class="btn btn-warning" onclick="FUNC_freeTalker('my')">释放发言</button></p>
            </div>
        </div>
    </div>
  </div>
</script>

<!-- 向设备喊话 模块 -->
<script id="tpl_startTalk" type="text/html">
  <div class="row">
    {{each list item}}
    <div class="col-md-6">
        <div class="thumbnail">
          <h3>{{item.DevId}}</h3>
          <p><button class="btn btn-primary" onclick="FUNC_startTalk('{{item.DevId}}')" >开始喊话</button>
              <button class="btn btn-default" onclick="FUNC_stopTalk('{{item.DevId}}')">停止喊话</button></p>
        </div>
    </div>
    {{/each}}        
  </div>
</script>

<!-- 获取实时位置 模块 -->
<script id="tpl_getGps" type="text/html">
  <table class="table table-bordered">
      <tr>
          <th>设备Id</th>
          <th>#</th>
          <th>#</th>
      </tr>
  {{each list item}}
      <tr>
          <td>
              {{item.DevId}}
          </td>
          <td>
            <button class="btn btn-primary" onclick="FUNC_getGps('{{item.DevId}}')" >获取GPS</button>
          </td>
          <td>
            <textarea id="txt_getGps_{{item.DevId}}">请先获取</textarea>
          </td>
      </tr>        
  {{/each}}
</table>
</script>

<!-- 获取设备参数 模块 -->
<script id="tpl_getDeviceInfo" type="text/html">
  <table class="table table-bordered">
    <tr>
        <th>设备Id</th>
        <th>#</th>    
        <th>#</th>     
    </tr>
{{each list item}}
    <tr>
        <td>
            {{item.DevId}}
        </td>
        <td>
          <button class="btn btn-primary" onclick="FUNC_getDeviceInfo('{{item.DevId}}')" >获取设备参数</button>
        </td>
        <td>
          <textarea id="txt_getDeviceInfo_{{item.DevId}}">请先获取</textarea>
        </td>
    </tr>        
{{/each}}
</table>
</script>

<!-- 下发录像指令 模块 -->
<script id="tpl_startRecord" type="text/html">
  <table class="table table-bordered">
    <tr>
        <th>设备Id</th>
        <th>#</th>
    </tr>
{{each list item}}
    <tr>
        <td>
            {{item.DevId}}
        </td>
        <td>
          <button class="btn btn-primary" onclick="FUNC_startRecord('{{item.DevId}}')" >开启录像</button>
          <button class="btn btn-default" onclick="FUNC_stopRecord('{{item.DevId}}')" >停止录像</button>
        </td>
    </tr>        
{{/each}}
</table>
</script>

<!-- 下发录像指令 模块 -->
<script id="tpl_startRecord" type="text/html">
  <table class="table table-bordered">
    <tr>
        <th>设备Id</th>
        <th>#</th>
    </tr>
{{each list item}}
    <tr>
        <td>
            {{item.DevId}}
        </td>
        <td>
          <button class="btn btn-primary" onclick="FUNC_startRecord('{{item.DevId}}')" >开启录像</button>
          <button class="btn btn-default" onclick="FUNC_stopRecord('{{item.DevId}}')" >停止录像</button>
        </td>
    </tr>        
{{/each}}
</table>
</script>

<!-- 下发工单消息 模块 -->
<script id="tpl_sendWorkNo" type="text/html">
  <table class="table table-bordered">
    <tr>
        <th>设备Id</th>
        <th>工单号</th>    
        <th>#</th>     
    </tr>
{{each list item}}
    <tr>
        <td>
            {{item.DevId}}
        </td>
        <td>
          <input type="text" value="W123456" id="txt_sendWorkNo_{{item.DevId}}"></textarea>
        </td>
        <td>
          <button class="btn btn-primary" onclick="FUNC_sendWorkNo('{{item.DevId}}', document.getElementById('txt_sendWorkNo_{{item.DevId}}').value)" >下发</button>
        </td>       
    </tr>        
{{/each}}
</table>
</script>

<!-- 下发文本消息 模块 -->
<script id="tpl_sendIM" type="text/html">
  <table class="table table-bordered">
    <tr>
        <th>设备Id</th>
        <th>内容</th>    
        <th>#</th>     
    </tr>
{{each list item}}
    <tr>
        <td>
            {{item.DevId}}
        </td>
        <td>
          <input type="text" value="做核酸了" id="txt_sendIM_{{item.DevId}}"></textarea>
        </td>
        <td>
          <button class="btn btn-primary" onclick="FUNC_sendIM('{{item.DevId}}', document.getElementById('txt_sendIM_{{item.DevId}}').value, false)" >文本消息</button>
          <button class="btn btn-primary" onclick="FUNC_sendIM('{{item.DevId}}', document.getElementById('txt_sendIM_{{item.DevId}}').value, true)" >TTS消息</button>
        </td>       
    </tr>        
{{/each}}
</table>
</script>

<!-- 第一个例子 模块 -->
<script id="tpl_demo" type="text/html">

  <div class="row">
    <div class="col-md-5">
      <ul id="devTree" class="ztree"></ul>
    </div>
    <div class="col-md-7">
      <div class="row">
        <div class="col-md-12">
          <div class="thumbnail">
              <video id="remoteVideo_2" controls autoplay muted></video>
              <audio id="remoteAudio_2" controls autoplay></audio>
              <div class="caption">                
                  <div class="input-group">                    
                    <input type="text" class="form-control" id="txtDeviceId" />
                    <span class="input-group-addon" style="width: 80px;">设备Id</span>
                  </div>
                  <div class="input-group">                    
                    <input type="text" class="form-control" id="txtDeviceName" />
                    <span class="input-group-addon" style="width: 80px;">设备名称</span>
                  </div>
                  <div class="input-group">                    
                    <input type="text" class="form-control" id="txtDeviceType" />
                    <span class="input-group-addon" style="width: 80px;">设备类型</span>
                  </div>
                  <hr />
                  <p><button class="btn btn-primary" onclick="FUNC_openVideo('')" >打开实时视频</button>
                     <button class="btn btn-default" onclick="FUNC_closeVideo('')">关闭视频</button>
                     <button class="btn btn-primary" onclick="FUNC_openAudio('')" >打开声音监听</button>
                     <button class="btn btn-default" onclick="FUNC_closeAudio('')">关闭监听</button></p>
                  <p><button class="btn btn-primary" onclick="FUNC_openVideo('')" >发起视频通话</button>
                     <button class="btn btn-default" onclick="FUNC_closeVideo('')">关闭通话</button>
                     <button class="btn btn-primary" onclick="FUNC_openAudio('')" >发起语音通话</button>
                     <button class="btn btn-default" onclick="FUNC_closeAudio('')">关闭通话</button></p>
              </div>
          </div>
      </div>
      </div>
    </div>
  </div>

</script>

<!-- MCS8 JavaScript Client SDK -->
<script src="jssdk/mcs8Client.js"></script>
<script src="jssdk/sdkDemo.js"></script>

<script>
  var __PAGE_KEY__ = "sdkdemo";
  $(function () {

    $("#btnCertificateInvalid").click(function (e) {
      var txtGatewayUrl = $("#txtGatewayUrl").val();
      try {
        new URL(txtGatewayUrl);
      } catch (error) {
        alert("输入网关地址/地址格式错误！正确格式示例：https://106.54.78.47:7715/gateway");
        return;
      }
      txtGatewayUrl = txtGatewayUrl.replace("gateway", "");
      window.open(txtGatewayUrl);
    });

    $('#menu a').click(function (e) {
      var key = $(this).data("key");
      if (key) {
        e.preventDefault();
        $(this).tab('show');
        eval(`FUNC_init_${key}('${key}')`);
      }
    });
  });
</script>

</html>